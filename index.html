<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finexy PRO v3.0 - Liberty Enterprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --primary: #0f172a;
            --accent: #4f46e5; --success: #22c55e; --danger: #ef4444;
            --warning: #f59e0b; --text: #1e293b; --sub: #64748b;
            --border: #e2e8f0; --shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
        }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.2s ease; }
        body { background: var(--bg); margin: 0; color: var(--text); padding-bottom: 60px; overflow-x: hidden; }
        
        /* HEADER & NAV */
        .navbar { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .logo { font-size: 1.6rem; font-weight: 800; color: var(--primary); letter-spacing: -1.5px; cursor: pointer; }
        .logo span { color: var(--accent); }
        
        .nav-links { display: flex; gap: 8px; background: #f1f5f9; padding: 5px; border-radius: 12px; }
        .nav-btn { border: none; background: none; padding: 8px 18px; border-radius: 8px; font-weight: 700; color: var(--sub); cursor: pointer; font-size: 0.8rem; }
        .nav-btn.active { background: #fff; color: var(--accent); box-shadow: var(--shadow); }

        .auth-zone { display: flex; align-items: center; gap: 12px; }
        select#session-select { border: 1px solid var(--border); padding: 8px; border-radius: 10px; font-weight: 700; outline: none; background: #fff; cursor: pointer; }

        /* LAYOUT */
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .main-grid { display: grid; grid-template-columns: 320px 1fr 300px; gap: 25px; }

        /* CARDS */
        .card { background: var(--card); border-radius: 24px; padding: 24px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: var(--shadow); }
        .card h3 { margin: 0 0 20px 0; font-size: 1rem; font-weight: 800; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        
        /* WALLET */
        .credit-card { height: 175px; border-radius: 20px; padding: 22px; color: white; margin-bottom: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-chip { width: 42px; height: 32px; background: #edbc5a; border-radius: 6px; }
        .card-num { font-size: 1.1rem; letter-spacing: 2px; font-weight: 500; }
        
        /* TABLE SYSTEM */
        .table-wrap { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 650px; }
        th { text-align: left; padding: 12px; color: var(--sub); font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border); letter-spacing: 1px; }
        td { padding: 16px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }

        /* INPUTS */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        .field label { font-size: 0.75rem; font-weight: 800; color: var(--sub); }
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: #f8fafc; outline: none; font-size: 0.9rem; }
        input:focus { border-color: var(--accent); background: #fff; }

        /* BUTTONS */
        .btn-main { background: var(--accent); color: #fff; border: none; padding: 14px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; font-size: 0.9rem; }
        .btn-main:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-reset { background: #fff; color: var(--danger); border: 1px solid var(--danger); padding: 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 800; cursor: pointer; margin-top: 20px; width: 100%; }
        .btn-reset:hover { background: var(--danger); color: #fff; }

        /* BADGES */
        .st-badge { padding: 5px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; border: none; cursor: pointer; }
        .bg-wait { background: #fff7ed; color: #f59e0b; }
        .bg-late { background: #fef2f2; color: #ef4444; animation: pulse 1.5s infinite; }
        .bg-done { background: #f0fdf4; color: #22c55e; }

        /* MODALS */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(6px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 28px; padding: 35px; width: 100%; max-width: 650px; max-height: 90vh; overflow-y: auto; }

        .hidden { display: none !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="navbar">
    <div class="logo" onclick="location.reload()">Finexy<span>.</span>PRO</div>
    <div class="nav-links">
        <button class="nav-btn active">Overview</button>
        <button class="nav-btn" onclick="UI.toggleAdm()">Gerenciar</button>
        <button class="nav-btn" onclick="UI.showReport()">Relat√≥rios</button>
    </div>
    <div class="auth-zone">
        <select id="session-select" onchange="Engine.switchUser(this.value)"></select>
    </div>
</div>

<div class="container">
    <div class="main-grid">
        
        <div class="sidebar">
            <div class="card">
                <h3>üí≥ Cart√µes Ativos</h3>
                <div id="ui-cards-list"></div>
                <button class="nav-btn" style="width:100%; border: 2px dashed var(--border); margin-top:10px" onclick="UI.openModal('modal-card')">+ Novo Cart√£o</button>
            </div>

            <div class="card" style="background: var(--primary); color: white;">
                <h3 style="color:white">üí∞ Cofre Liberty</h3>
                <div id="ui-total-cofre" style="font-size: 2rem; font-weight: 800; margin-bottom: 5px;">R$ 0,00</div>
                <div style="font-size: 0.7rem; color: var(--sub);">Dispon√≠vel para baixas</div>
                <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 15px 0;">
                    <div id="ui-progress" style="height:100%; background: var(--success); width: 0%; transition: 1s;"></div>
                </div>
                <div style="font-size: 0.8rem; font-weight: 700; text-align: right;" id="ui-perc-txt">0%</div>
            </div>

            <button class="btn-reset" onclick="Engine.resetSystem()">‚ö†Ô∏è LIMPAR TODO O SISTEMA</button>
        </div>

        <div class="main-content">
            <div id="view-admin" class="card hidden" style="border: 2px solid var(--accent)">
                <h3 style="color:var(--accent)">‚öôÔ∏è Lan√ßar Rateio Coletivo</h3>
                <div class="form-row">
                    <div class="field">
                        <label>Descri√ß√£o</label>
                        <input id="f-desc" placeholder="Ex: Mercado Mensal">
                    </div>
                    <div class="field">
                        <label>Valor Total (R$)</label>
                        <input id="f-val" type="number" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="field">
                        <label>Categoria</label>
                        <select id="f-cat">
                            <option value="Fixas">üè† Contas Fixas</option>
                            <option value="Mercado">üõí Mercado</option>
                            <option value="Lazer">üçï Lazer / Comida</option>
                            <option value="Saude">üè• Sa√∫de</option>
                            <option value="Outros">üì¶ Outros</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Vencimento</label>
                        <input id="f-date" type="date">
                    </div>
                </div>
                <div class="form-row">
                    <div class="field">
                        <label>Cart√£o Utilizado</label>
                        <select id="f-card-id"></select>
                    </div>
                    <div class="field">
                        <label>Parcelamento</label>
                        <select id="f-vezes">
                            <option value="1">√Ä vista</option>
                            <option value="2">2x</option>
                            <option value="12">12x</option>
                        </select>
                    </div>
                </div>
                <div class="field">
                    <label>Quem vai pagar?</label>
                    <div id="ui-check-membros" style="display:flex; gap:12px; flex-wrap:wrap; padding:12px; background:#f8fafc; border-radius:12px; border:1px solid var(--border)"></div>
                </div>
                <button class="btn-main" style="margin-top:20px" onclick="Engine.createBill()">Lan√ßar e Notificar Grupo</button>

                <h4 style="margin-top:30px">‚úÖ Baixas Pendentes (Pagar Vendedor)</h4>
                <div id="ui-baixas-lista" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px"></div>
            </div>

            <div class="card">
                <h3>üìÖ Minhas Cobran√ßas e Status</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Membro</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="ui-table-parcelas"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>üìù Hist√≥rico de Auditoria</h3>
                <div id="ui-logs-lista" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <h3>üìä Gastos por Categoria</h3>
                <div style="height:220px"><canvas id="chartCat"></canvas></div>
            </div>
            <div class="card">
                <h3>üìà Performance (Cofre)</h3>
                <div style="height:220px"><canvas id="chartPerf"></canvas></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-card" class="overlay">
    <div class="modal-content">
        <h3>Cadastrar Cart√£o Real</h3>
        <div class="form-row">
            <input id="c-nome" placeholder="Nome do Cart√£o">
            <input id="c-limite" type="number" placeholder="Limite Total">
        </div>
        <div class="form-row">
            <input id="c-venc" type="number" placeholder="Dia Vencimento">
            <select id="c-cor">
                <option value="linear-gradient(135deg, #4f46e5 0%, #312e81 100%)">Azul Royal</option>
                <option value="linear-gradient(135deg, #820ad1 0%, #4c0677 100%)">Roxo Nubank</option>
                <option value="linear-gradient(135deg, #1e293b 0%, #0f172a 100%)">Black Premium</option>
            </select>
        </div>
        <button class="btn-main" onclick="Engine.addCard()">Salvar Cart√£o</button>
        <button class="nav-btn" style="width:100%; margin-top:10px" onclick="UI.closeModal('modal-card')">Fechar</button>
    </div>
</div>

<div id="modal-report" class="overlay">
    <div class="modal-content">
        <h3>üìä Relat√≥rio Consolidado</h3>
        <div id="report-body"></div>
        <button class="btn-main" style="margin-top:20px" onclick="UI.closeModal('modal-report')">Fechar</button>
    </div>
</div>

<script>
const FIREBASE_URL = "https://grupo-ryan-default-rtdb.firebaseio.com/dados.json";
let DB = { membros: [], contas: [], parcelas: [], cartoes: [], logs: [], cofreCentavos: 0 };
let cCat, cPerf;

const Utils = {
    toC: v => Math.round(parseFloat(v || 0) * 100),
    toR: c => ((c || 0) / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
    genId: p => p + '_' + Math.random().toString(36).substr(2, 9),
    hoje: () => new Date().toISOString().split('T')[0],
    addMes: (d, m) => { let x = new Date(d + 'T12:00:00'); x.setMonth(x.getMonth() + m); return x.toISOString().split('T')[0]; }
};

const Engine = {
    PASS: "1234",
    activeUser: null,

    async init() {
        await this.load();
        this.initCharts();
        const saved = localStorage.getItem("activeUserId");
        this.activeUser = DB.membros.find(m => m.id === saved) || DB.membros[0];
        this.render();
        setInterval(() => this.load(), 5000);
    },

    async load() {
        try {
            let r = await fetch(FIREBASE_URL);
            let d = await r.json();
            if (d) { 
                DB = { ...DB, ...d };
                this.render(); 
            }
        } catch (e) { console.error("Erro conex√£o"); }
    },

    async save() {
        await fetch(FIREBASE_URL, { method: 'PUT', body: JSON.stringify(DB) });
        this.render();
    },

    addLog(tipo, msg, valor) {
        if (!DB.logs) DB.logs = [];
        DB.logs.unshift({ tipo, msg, valor, user: this.activeUser.nome, data: new Date().toLocaleString() });
        if (DB.logs.length > 100) DB.logs.pop();
    },

    addCard() {
        const n = document.getElementById("c-nome"), l = document.getElementById("c-limite");
        if (!n.value || !l.value) return;
        if (!DB.cartoes) DB.cartoes = [];
        DB.cartoes.push({ id: Utils.genId('crd'), nome: n.value, limite: Utils.toC(l.value), venc: document.getElementById("c-venc").value, cor: document.getElementById("c-cor").value, fatura: 0 });
        this.addLog("SISTEMA", `Cart√£o ${n.value} adicionado`, 0);
        n.value = ""; l.value = ""; 
        UI.closeModal('modal-card');
        this.save();
    },

    createBill() {
        const d = document.getElementById("f-desc"), v = document.getElementById("f-val"), 
              cat = document.getElementById("f-cat"), dt = document.getElementById("f-date"),
              ct = document.getElementById("f-card-id"), vz = parseInt(document.getElementById("f-vezes").value);
        const checks = document.querySelectorAll(".m-cb:checked");

        if (!d.value || !v.value || !dt.value || !checks.length) return alert("Preencha tudo!");

        const vt = Utils.toC(v.value), vm = Math.round(vt / vz);

        if (ct.value) {
            const card = DB.cartoes.find(x => x.id === ct.value);
            if (card) card.fatura = (card.fatura || 0) + vt;
        }

        for (let i = 0; i < vz; i++) {
            const cid = Utils.genId("cnt"), dv = Utils.addMes(dt.value, i);
            DB.contas.push({ id: cid, desc: vz > 1 ? `${d.value} (${i+1}/${vz})` : d.value, total: vm, venc: dv, status: "aberta", cartaoId: ct.value, categoria: cat.value });
            checks.forEach(cb => {
                DB.parcelas.push({ id: Utils.genId("prc"), contaId: cid, membroId: cb.dataset.id, membroNome: cb.value, valorBase: Math.round(vm / checks.length), pago: false });
            });
        }
        
        this.addLog("RATEIO", `Rateio de ${d.value} lan√ßado`, vt);
        // LIMPEZA AUTOM√ÅTICA DOS CAMPOS
        d.value = ""; v.value = ""; dt.value = "";
        this.save();
    },

    pay(id) {
        const p = DB.parcelas.find(x => x.id === id);
        if (!p || p.pago) return;
        const c = DB.contas.find(x => x.id === p.contaId);
        const multa = Utils.hoje() > c.venc ? 500 : 0;
        p.pago = true;
        p.vFinal = p.valorBase + multa;
        DB.cofreCentavos = (DB.cofreCentavos || 0) + p.vFinal;
        this.addLog("PAGAMENTO", `${p.membroNome} pagou ${c.desc}`, p.vFinal);
        this.save();
    },

    darBaixa(id) {
        const c = DB.contas.find(x => x.id === id);
        if (DB.cofreCentavos < c.total) return alert("Cofre insuficiente!");
        c.status = "quitada";
        DB.cofreCentavos -= c.total;
        if (c.cartaoId) {
            const card = DB.cartoes.find(x => x.id === c.cartaoId);
            if (card) card.fatura -= c.total;
        }
        this.addLog("BAIXA", `Conta ${c.desc} quitada com sucesso`, c.total);
        this.save();
    },

    resetSystem() {
        if (prompt("SENHA MESTRE PARA RESETAR TUDO:") !== this.PASS) return;
        if (!confirm("Isso apagar√° todas as contas e hist√≥ricos. Continuar?")) return;
        DB.contas = []; DB.parcelas = []; DB.logs = []; DB.cofreCentavos = 0;
        if (DB.cartoes) DB.cartoes.forEach(c => c.fatura = 0);
        this.save();
    },

    switchUser(id) {
        const u = DB.membros.find(m => m.id === id);
        if (u.role === "ADMIN" && prompt("Senha:") !== this.PASS) return this.render();
        this.activeUser = u; localStorage.setItem("activeUserId", id);
        this.render();
    },

    initCharts() {
        const cfg = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
        cCat = new Chart(document.getElementById("chartCat"), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4f46e5', '#22c55e', '#ef4444', '#f59e0b', '#64748b'] }] }, options: cfg });
        cPerf = new Chart(document.getElementById("chartPerf"), { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#4f46e5', tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)' }] }, options: cfg });
    },

    render() {
        if (!this.activeUser) return;
        document.getElementById("ui-total-cofre").innerText = Utils.toR(DB.cofreCentavos);
        document.getElementById("session-select").innerHTML = DB.membros.map(m => `<option value="${m.id}" ${m.id === this.activeUser.id ? 'selected' : ''}>${m.nome}</option>`).join("");
        document.getElementById("ui-check-membros").innerHTML = DB.membros.map(m => `<label style="font-size:0.7rem; font-weight:800"><input class="m-cb" type="checkbox" data-id="${m.id}" value="${m.nome}" checked> ${m.nome}</label>`).join("");

        // Cart√µes
        document.getElementById("ui-cards-list").innerHTML = (DB.cartoes || []).map(c => `
            <div class="credit-card" style="background: ${c.cor}">
                <div style="display:flex; justify-content:space-between">
                    <div class="card-chip"></div>
                    <div style="font-weight:800; opacity:0.8">VISA</div>
                </div>
                <div>
                    <div style="font-size:0.7rem; opacity:0.8">${c.nome}</div>
                    <div style="font-size:1.4rem; font-weight:800">${Utils.toR(c.fatura || 0)}</div>
                    <div style="font-size:0.55rem; margin-top:5px">Limite: ${Utils.toR(c.limite)} | Venc: Dia ${c.venc}</div>
                </div>
            </div>
        `).join("");
        document.getElementById("f-card-id").innerHTML = `<option value="">üíµ Dinheiro (Cofre)</option>` + (DB.cartoes || []).map(c => `<option value="${c.id}">${c.nome}</option>`).join("");

        // Tabelas
        const isAdm = this.activeUser.role === "ADMIN";
        const parcelas = isAdm ? DB.parcelas : DB.parcelas.filter(p => p.membroId === this.activeUser.id);
        
        document.getElementById("ui-table-parcelas").innerHTML = parcelas.filter(p => !p.pago).map(p => {
            const c = DB.contas.find(x => x.id === p.contaId);
            if (!c || c.status === "quitada") return "";
            const late = Utils.hoje() > c.venc;
            return `<tr>
                <td><b>${c.desc}</b></td>
                <td>${p.membroNome}</td>
                <td style="font-weight:800">${Utils.toR(late ? p.valorBase + 500 : p.valorBase)}</td>
                <td><span class="st-badge ${late ? 'bg-late' : 'bg-wait'}">${late ? 'ATRASADO' : 'PENDENTE'}</span></td>
                <td><button class="st-badge bg-done" onclick="Engine.pay('${p.id}')">PAGAR</button></td>
            </tr>`;
        }).join("");

        // Baixas
        document.getElementById("ui-baixas-lista").innerHTML = DB.contas.filter(c => c.status === "aberta").map(c => `
            <div style="padding:12px; background:#f1f5f9; border-radius:12px; display:flex; justify-content:space-between; align-items:center">
                <span style="font-size:0.75rem"><b>${c.desc}</b><br>${Utils.toR(c.total)}</span>
                <button class="st-badge bg-done" onclick="Engine.darBaixa('${c.id}')">BAIXAR</button>
            </div>
        `).join("");

        // Logs
        document.getElementById("ui-logs-lista").innerHTML = (DB.logs || []).map(l => `
            <div style="padding:10px; border-bottom:1px solid #f1f5f9; font-size:0.75rem; display:flex; justify-content:space-between">
                <span><b>${l.tipo}</b>: ${l.msg}</span>
                <span style="color:var(--sub)">${Utils.toR(l.valor)}</span>
            </div>
        `).join("");

        // Gr√°ficos
        const catStats = {}; DB.contas.forEach(c => catStats[c.categoria] = (catStats[c.categoria] || 0) + c.total/100);
        cCat.data.labels = Object.keys(catStats); cCat.data.datasets[0].data = Object.values(catStats); cCat.update();
        
        const totalMes = DB.contas.reduce((a,b) => a+b.total, 0);
        document.getElementById("ui-progress").style.width = Math.min((DB.cofreCentavos/(totalMes||1))*100, 100) + "%";
        document.getElementById("ui-perc-txt").innerText = Math.round((DB.cofreCentavos/(totalMes||1))*100) + "%";
        
        cPerf.data.labels = (DB.logs || []).slice(0, 7).reverse().map(l => l.data.split(',')[0]);
        cPerf.data.datasets[0].data = (DB.logs || []).slice(0, 7).reverse().map(l => l.valor/100);
        cPerf.update();
    }
};

const UI = {
    toggleAdm() {
        if (Engine.activeUser.role !== "ADMIN" && prompt("ADMIN PASS:") !== Engine.PASS) return;
        document.getElementById("view-admin").classList.toggle("hidden");
    },
    openModal(id) { document.getElementById(id).style.display = 'flex'; },
    closeModal(id) { document.getElementById(id).style.display = 'none'; },
    showReport() {
        const total = DB.contas.reduce((a, b) => a + b.total, 0);
        const arrecadado = DB.cofreCentavos;
        const baixadas = DB.contas.filter(c => c.status === "quitada").reduce((a,b) => a+b.total, 0);
        
        document.getElementById("report-body").innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
                <div class="card" style="margin:0; background:#f8fafc"><small>Gasto Criado</small><h3>${Utils.toR(total)}</h3></div>
                <div class="card" style="margin:0; background:#f0fdf4"><small>J√° Arrecadado</small><h3>${Utils.toR(arrecadado)}</h3></div>
                <div class="card" style="margin:0; background:#eff6ff"><small>Baixas Efetuadas</small><h3>${Utils.toR(baixadas)}</h3></div>
                <div class="card" style="margin:0; background:#fef2f2"><small>Saldo Pendente de Baixa</small><h3>${Utils.toR(total - baixadas)}</h3></div>
            </div>
            <h4 style="margin-top:20px">Contribui√ß√£o Real por Membro</h4>
            ${DB.membros.map(m => {
                const totalM = DB.parcelas.filter(p => p.membroId === m.id && p.pago).reduce((a,b) => a+b.vFinal, 0);
                return `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee">
                    <span>${m.nome}</span><b>${Utils.toR(totalM)}</b>
                </div>`;
            }).join("")}
        `;
        this.openModal('modal-report');
    }
};

Engine.init();
</script>
</body>
</html>
