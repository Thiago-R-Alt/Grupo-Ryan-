<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rateio Grupo Ryan v6.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; --dark: #0f172a; --slate: #64748b; --bg: #0f172a; --card: #1e293b; --warning: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; color: #fff; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .header-status { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #fff; padding: 30px 20px; border-radius: 24px; text-align: center; margin-bottom: 20px; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        .val-total { font-size: 2.5rem; font-weight: 800; color: var(--success); margin: 5px 0; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #334155; }
        h4 { margin: 0 0 15px 0; font-size: 0.9rem; border-bottom: 1px solid #334155; padding-bottom: 8px; color: var(--slate); text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 12px; background: #0f172a; color: #fff; margin-top: 6px; box-sizing: border-box; }
        .btn { cursor: pointer; border: none; border-radius: 12px; padding: 14px; font-weight: 700; width: 100%; transition: 0.2s; display: block; font-size: 1rem; margin-top: 10px; text-align: center; text-decoration: none; }
        .btn-p { background: var(--primary); color: #fff; }
        .btn-s { background: var(--success); color: #fff; }
        .btn-ghost { background: transparent; color: var(--slate); border: 1px solid #334155; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 12px 5px; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        .tag { padding: 6px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; cursor: pointer; border: none; }
        .tag-pago { background: #064e3b; color: #10b981; }
        .tag-pendente { background: #7f1d1d; color: #f87171; }
        .member-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #161e2e; border-radius: 12px; margin-bottom: 8px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #fff; color: #000; padding: 20px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; }
        #qrcode-container { display: flex; justify-content: center; margin: 15px 0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="pix-modal" class="modal hidden">
    <div class="modal-content">
        <h3>Pagar via Pix</h3>
        <p id="pix-destinatario" style="font-size: 0.8rem;"></p>
        <div id="qrcode-container"></div>
        <input id="pix-copia-cola" readonly style="background: #f1f5f9; color: #334155; font-size: 0.7rem; border: 1px dashed #cbd5e1; width: 100%;">
        <button class="btn btn-p" onclick="UI.copyPix()">Copiar C√≥digo Pix</button>
        <button class="btn btn-ghost" onclick="UI.closePix()">Fechar</button>
    </div>
</div>

<div class="container">
    <div style="display:flex; gap:10px; margin-bottom:15px">
        <select id="session-select" onchange="Engine.switchUser(this.value)"></select>
        <button class="btn btn-ghost" style="width:auto; padding: 8px 15px;" onclick="UI.toggleAdm()">‚öôÔ∏è ADM</button>
    </div>

    <div class="header-status">
        <small>SALDO NO COFRE</small>
        <div class="val-total" id="ui-cofre">R$ 0,00</div>
        <div id="user-role-badge" style="font-size: 0.8rem; color: var(--slate);">Carregando...</div>
    </div>

    <div id="view-admin" class="card hidden">
        <h4>üìù Novo Rateio</h4>
        <input id="f-desc" placeholder="Ex: Aluguel">
        <div style="display: flex; gap: 10px;">
            <input id="f-val" type="number" placeholder="Valor">
            <input id="f-date" type="date">
        </div>
        <div id="ui-member-check-list" style="margin-top:10px"></div>
        <button class="btn btn-s" onclick="Engine.createMainBill()">GERAR RATEIO</button>

        <h4 style="margin-top:25px">üë• Moradores e Pix</h4>
        <div id="ui-manage-members"></div>
        <div class="card" style="background:#0f172a; padding:10px">
            <input id="f-new-mem" placeholder="Nome" style="margin:0">
            <input id="f-new-pix" placeholder="Chave Pix" style="margin-top:5px">
            <button class="btn btn-p" onclick="Engine.addMember()">Adicionar</button>
        </div>

        <h4>üí∞ Baixas</h4>
        <table id="ui-baixas-gerais"></table>
        <button class="btn btn-danger" onclick="Engine.resetAll()" style="font-size: 0.7rem;">RESETAR TUDO</button>
    </div>

    <div class="card">
        <h4>üìã Minhas Parcelas</h4>
        <table id="ui-minhas-parcelas"></table>
    </div>
</div>

<script>
const b1 = "https://grupo-ryan-";
const b2 = "default-rtdb.firebaseio.com/dados.json";
const FIREBASE_URL = b1 + b2;

let DB = { 
    membros: [{id:"u1",nome:"Thiago",role:"ADMIN",pix:""}], 
    contas: [], parcelas: [], cofreCentavos: 0 
};

const Utils = {
    toC: v => Math.round(parseFloat(v)*100),
    toR: c => (c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}),
    genId: p => p+'_'+Math.random().toString(36).substr(2,9),
    hoje: () => new Date().toISOString().split('T')[0]
};

const Engine = {
    activeUser: null,
    ADMIN_PASS: "1234",

    async init() {
        await this.load();
        
        // CORRE√á√ÉO: Tenta recuperar o usu√°rio salvo AP√ìS o DB carregar
        const savedUserId = localStorage.getItem("activeUserId");
        if (savedUserId) {
            const found = DB.membros.find(m => m.id === savedUserId);
            this.activeUser = found || DB.membros[0];
        } else {
            this.activeUser = DB.membros[0];
        }
        
        this.render();
        setInterval(() => this.load(), 5000);
    },

    async load() {
        try {
            const res = await fetch(FIREBASE_URL);
            const data = await res.json();
            if (data) { 
                DB = data; 
                // Se o usu√°rio logado sumiu do banco (removido), volta pro Thiago
                if (this.activeUser && !DB.membros.find(m => m.id === this.activeUser.id)) {
                    this.activeUser = DB.membros[0];
                }
                this.render(); 
            }
        } catch (e) { console.error("Erro rede"); }
    },

    async save() {
        await fetch(FIREBASE_URL, { method: 'PUT', body: JSON.stringify(DB) });
        this.render();
    },

    switchUser(id) {
        const t = DB.membros.find(m => m.id === id);
        if (t?.role === "ADMIN") {
            if (prompt("Senha ADM:") !== this.ADMIN_PASS) {
                this.render(); // Reseta visualmente o select
                return;
            }
        }
        this.activeUser = t;
        localStorage.setItem("activeUserId", t.id); // Salva apenas o ID para ser mais robusto
        this.render();
    },

    addMember() {
        const n = document.getElementById("f-new-mem").value, p = document.getElementById("f-new-pix").value;
        if(!n) return;
        DB.membros.push({id: Utils.genId('u'), nome: n, role: "MEMBRO", pix: p});
        document.getElementById("f-new-mem").value = ""; document.getElementById("f-new-pix").value = "";
        this.save();
    },

    createMainBill() {
        const d = document.getElementById("f-desc").value, v = Utils.toC(document.getElementById("f-val").value), dt = document.getElementById("f-date").value, cbs = document.querySelectorAll(".m-cb:checked");
        if(!d || v <= 0 || !cbs.length) return alert("Preencha tudo");
        const cid = Utils.genId('c');
        DB.contas.push({id:cid, desc:d, total:v, venc:dt, status:"aberta", criadoPor: this.activeUser.id});
        cbs.forEach(cb => {
            DB.parcelas.push({id:Utils.genId('p'), contaId:cid, membroId:cb.dataset.id, membroNome:cb.value, valorBase:Math.round(v/cbs.length), pago:false});
        });
        this.save();
    },

    payParcela(id) {
        const p = DB.parcelas.find(x => x.id === id);
        const c = DB.contas.find(x => x.id === p.contaId);
        const mult = Utils.hoje() > c.venc ? 500 : 0;
        p.pago = true; p.valorPagoFinal = p.valorBase + mult;
        DB.cofreCentavos += p.valorPagoFinal;
        this.save();
    },

    darBaixa(id) {
        const c = DB.contas.find(x => x.id === id);
        if(DB.cofreCentavos < c.total) return alert("Saldo insuficiente!");
        c.status = "quitada"; DB.cofreCentavos -= c.total;
        this.save();
    },

    resetAll() { if(confirm("Apagar tudo?")) { DB.contas=[]; DB.parcelas=[]; DB.cofreCentavos=0; this.save(); } }
};

const UI = {
    toggleAdm: () => {
        if (Engine.activeUser.role !== "ADMIN") {
            if (prompt("Senha ADM:") !== Engine.ADMIN_PASS) return;
        }
        document.getElementById("view-admin").classList.toggle("hidden");
    },

    showPix(parcelaId) {
        const p = DB.parcelas.find(x => x.id === parcelaId);
        const c = DB.contas.find(x => x.id === p.contaId);
        const recebedor = DB.membros.find(m => m.id === c.criadoPor) || DB.membros[0];
        
        if(!recebedor.pix) return alert("Recebedor sem chave Pix!");

        const valor = (p.valorBase + (Utils.hoje() > c.venc ? 500 : 0)) / 100;
        const payload = `00020126330014BR.GOV.BCB.PIX01${recebedor.pix.length}${recebedor.pix}520400005303986540${valor.toFixed(2)}5802BR5910${recebedor.nome.substring(0,10)}6009SAO PAULO62070503***6304`;

        document.getElementById("pix-modal").classList.remove("hidden");
        document.getElementById("pix-destinatario").innerText = `Para: ${recebedor.nome}`;
        document.getElementById("pix-copia-cola").value = payload;
        
        const qrContainer = document.getElementById("qrcode-container");
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, { text: payload, width: 200, height: 200 });
    },

    closePix: () => document.getElementById("pix-modal").classList.add("hidden"),
    copyPix: () => {
        const cp = document.getElementById("pix-copia-cola");
        cp.select(); document.execCommand("copy"); alert("Copiado!");
    },

    render() {
        if(!Engine.activeUser) return;
        const isAdm = Engine.activeUser.role === "ADMIN";
        document.getElementById("ui-cofre").innerText = Utils.toR(DB.cofreCentavos);
        document.getElementById("user-role-badge").innerText = `${Engine.activeUser.nome} ‚Ä¢ ${Engine.activeUser.role}`;
        
        document.getElementById("session-select").innerHTML = DB.membros.map(m => `<option value="${m.id}" ${m.id === Engine.activeUser.id ? "selected" : ""}>üë§ ${m.nome}</option>`).join("");
        
        document.getElementById("ui-member-check-list").innerHTML = DB.membros.map(m => `
            <label class="member-row"><input type="checkbox" class="m-cb" data-id="${m.id}" value="${m.nome}" checked> ${m.nome}</label>
        `).join("");

        document.getElementById("ui-manage-members").innerHTML = DB.membros.map(m => `
            <div class="member-row"><span>${m.nome} <small>(${m.pix || 'N/A'})</small></span></div>
        `).join("");

        document.getElementById("ui-baixas-gerais").innerHTML = DB.contas.filter(c => c.status === "aberta").map(c => `
            <tr><td><b>${c.desc}</b><br><small>${Utils.toR(c.total)}</small></td><td style="text-align:right"><button class="tag tag-pago" onclick="Engine.darBaixa('${c.id}')">BAIXAR</button></td></tr>
        `).join("");

        const vis = isAdm ? DB.parcelas : DB.parcelas.filter(p => p.membroId === Engine.activeUser.id);
        document.getElementById("ui-minhas-parcelas").innerHTML = vis.map(p => {
            const c = DB.contas.find(x => x.id === p.contaId);
            if(!c || c.status === "quitada") return "";
            const atraso = !p.pago && Utils.hoje() > c.venc;
            return `<tr>
                <td><b>${c.desc}</b></td>
                <td><b>${Utils.toR(p.pago?p.valorPagoFinal:(atraso?p.valorBase+500:p.valorBase))}</b></td>
                <td style="text-align:right">
                    ${p.pago ? '<span class="tag tag-pago">OK</span>' : `
                        <button class="tag tag-pendente" onclick="Engine.payParcela('${p.id}')">PAGAR</button>
                        <button class="tag" style="background:#32bcad; color:#fff;" onclick="UI.showPix('${p.id}')">PIX</button>
                    `}
                </td>
            </tr>`;
        }).join("");
    }
};

Engine.init();
</script>
</body>
</html>
